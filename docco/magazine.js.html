<!DOCTYPE html>

<html>
<head>
  <title>magazine.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>

    <ul class="sections">

          <li id="title">
              <div class="annotation">
                  <h1>magazine.js</h1>
              </div>
          </li>



        <li id="section-1">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>

            </div>

            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> ok = <span class="hljs-built_in">require</span>(<span class="hljs-string">'assert'</span>).ok,
    slice = [].slice

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">detach</span> (<span class="hljs-params">cartridge</span>) </span>{
    <span class="hljs-keyword">var</span> magazine = cartridge._magazine, cache = magazine._cache
    magazine.heft -= cartridge.heft
    cache.heft -= cartridge.heft
    <span class="hljs-keyword">delete</span> cache._cache[cartridge._compoundKey]
    magazine.count--
    cache.count--
    cartridge._detached = <span class="hljs-literal">true</span>
    unlink(cartridge)
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">unlink</span> (<span class="hljs-params">cartridge, prefix</span>) </span>{
    <span class="hljs-keyword">if</span> (!prefix) {
        unlink(cartridge, <span class="hljs-string">'cache'</span>)
        unlink(cartridge, <span class="hljs-string">'magazine'</span>)
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">var</span> prev = <span class="hljs-string">'_'</span> + prefix + <span class="hljs-string">'Previous'</span>
        <span class="hljs-keyword">var</span> next = <span class="hljs-string">'_'</span> + prefix + <span class="hljs-string">'Next'</span>
        cartridge[prev][next] = cartridge[next]
        cartridge[next][prev] = cartridge[prev]
    }
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">link</span> (<span class="hljs-params">cartridge, previous, prefix</span>) </span>{
    <span class="hljs-keyword">var</span> prev = <span class="hljs-string">'_'</span> + prefix + <span class="hljs-string">'Previous'</span>
    <span class="hljs-keyword">var</span> next = <span class="hljs-string">'_'</span> + prefix + <span class="hljs-string">'Next'</span>
    cartridge[next] = previous[next]
    cartridge[prev] = previous
    cartridge[next][prev] = cartridge
    previous[next] = cartridge
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Cache</span> (<span class="hljs-params">options</span>) </span>{
    options = options || {}

    ok(!options.clock)
    <span class="hljs-keyword">this</span>._Date = options.Date || <span class="hljs-built_in">Date</span>

    <span class="hljs-keyword">var</span> head = {}
    head._cachePrevious = head._cacheNext = head

    <span class="hljs-keyword">this</span>._cache = {}
    <span class="hljs-keyword">this</span>._head = head
    <span class="hljs-keyword">this</span>._nextKey = <span class="hljs-number">0</span>

    <span class="hljs-keyword">this</span>.count = <span class="hljs-number">0</span>
    <span class="hljs-keyword">this</span>.holds = <span class="hljs-number">0</span>
    <span class="hljs-keyword">this</span>.heft = <span class="hljs-number">0</span>
}

Cache.prototype.createMagazine = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">var</span> key = <span class="hljs-string">':'</span> + (++<span class="hljs-keyword">this</span>._nextKey) + <span class="hljs-string">':'</span>
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Magazine(<span class="hljs-keyword">this</span>, key)
}

Cache.prototype.purge = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">return</span> purge.call(<span class="hljs-keyword">this</span>, <span class="hljs-string">'_cachePrevious'</span>, slice.call(<span class="hljs-built_in">arguments</span>))
}

Cache.prototype.expire = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">expired</span>) </span>{
    expire(<span class="hljs-keyword">this</span>, expired)
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Magazine</span> (<span class="hljs-params">cache, key</span>) </span>{
    <span class="hljs-keyword">var</span> head = { <span class="hljs-attr">key</span>: <span class="hljs-literal">null</span>, <span class="hljs-attr">when</span>: <span class="hljs-literal">null</span>, <span class="hljs-attr">_terminal</span>: <span class="hljs-literal">true</span> }
    head._magazinePrevious = head._magazineNext = head

    <span class="hljs-keyword">this</span>._cache = cache
    <span class="hljs-keyword">this</span>._key = key
    <span class="hljs-keyword">this</span>._head = head

    <span class="hljs-keyword">this</span>.count = <span class="hljs-number">0</span>
    <span class="hljs-keyword">this</span>.holds = <span class="hljs-number">0</span>
    <span class="hljs-keyword">this</span>.heft = <span class="hljs-number">0</span>
}

Magazine.prototype.hold = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">key, initializer</span>) </span>{
</pre></div></div>

        </li>


        <li id="section-2">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>TODO Remove once you’re certain you’re not using function initializers.</p>

            </div>

            <div class="content"><div class='highlight'><pre>    ok(<span class="hljs-keyword">typeof</span> initializer != <span class="hljs-string">'function'</span>)
    <span class="hljs-keyword">var</span> compoundKey = <span class="hljs-keyword">this</span>._key + key
    <span class="hljs-keyword">var</span> cartridge = <span class="hljs-keyword">this</span>._cache._cache[compoundKey]
    <span class="hljs-keyword">if</span> (!cartridge) {
        cartridge = <span class="hljs-keyword">this</span>._cache._cache[compoundKey] =
            <span class="hljs-keyword">new</span> Cartridge(<span class="hljs-keyword">this</span>, key, initializer, compoundKey)
        <span class="hljs-keyword">this</span>.count++
        <span class="hljs-keyword">this</span>._cache.count++
    } <span class="hljs-keyword">else</span> {
        unlink(cartridge)
    }
    link(cartridge, <span class="hljs-keyword">this</span>._cache._head, <span class="hljs-string">'cache'</span>)
    link(cartridge, <span class="hljs-keyword">this</span>._head, <span class="hljs-string">'magazine'</span>)
    cartridge.holds++
    <span class="hljs-keyword">this</span>.holds++
    <span class="hljs-keyword">this</span>._cache.holds++
    cartridge.when = <span class="hljs-keyword">this</span>._cache._Date.now()
    <span class="hljs-keyword">return</span> cartridge
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">expire</span> (<span class="hljs-params">collection, expired</span>) </span>{
    <span class="hljs-keyword">var</span> purge = collection.purge()
    <span class="hljs-keyword">while</span> (purge.cartridge &amp;&amp; purge.cartridge.when &lt;= expired) {
        purge.cartridge.remove()
        purge.next()
    }
    purge.release()
}

</pre></div></div>

        </li>


        <li id="section-3">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>TODO Legacy, do not document, use expire or iterator interface.</p>

            </div>

            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">purge</span> (<span class="hljs-params">next, vargs</span>) </span>{
    <span class="hljs-keyword">var</span> downTo, condition, gather, stop, head, iterator, cache, magazine
    <span class="hljs-keyword">if</span> (vargs.length == <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Purge(<span class="hljs-keyword">this</span>, next)
    }
    downTo = vargs.shift()
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> vargs[<span class="hljs-number">0</span>] == <span class="hljs-string">'function'</span>) {
        condition = vargs.shift()
    }
    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">Array</span>.isArray(vargs[<span class="hljs-number">0</span>])) {
        gather = vargs.shift()
    }
    condition || (condition = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{ <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span> })
    stop = downTo
    head = <span class="hljs-keyword">this</span>._head
    iterator = head
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> downTo == <span class="hljs-string">'number'</span>) {
        downTo = <span class="hljs-built_in">Math</span>.max(downTo, <span class="hljs-number">-1</span>)
        stop = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{ <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.heft &lt;= downTo }.bind(<span class="hljs-keyword">this</span>)
    }
    <span class="hljs-keyword">while</span> (iterator[next] !== head &amp;&amp; !stop(iterator[next])) {
        <span class="hljs-keyword">var</span> cartridge = iterator[next]
        <span class="hljs-keyword">if</span> (!cartridge.holds &amp;&amp; condition(cartridge)) {
            magazine = cartridge._magazine, cache = magazine._cache
            <span class="hljs-keyword">if</span> (gather) {
                gather.push(cartridge.value)
            }
            detach(cartridge)
        } <span class="hljs-keyword">else</span> {
            iterator = cartridge
        }
    }
}

Magazine.prototype.purge = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">return</span> purge.call(<span class="hljs-keyword">this</span>, <span class="hljs-string">'_magazinePrevious'</span>, slice.call(<span class="hljs-built_in">arguments</span>))
}

Magazine.prototype.expire = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">expired</span>) </span>{
    expire(<span class="hljs-keyword">this</span>, expired)
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Cartridge</span> (<span class="hljs-params">magazine, key, value, compoundKey</span>) </span>{
    <span class="hljs-keyword">this</span>.key = key
    <span class="hljs-keyword">this</span>.value = value

    <span class="hljs-keyword">this</span>._magazine = magazine
    <span class="hljs-keyword">this</span>._compoundKey = compoundKey
    <span class="hljs-keyword">this</span>._terminal = <span class="hljs-literal">false</span>

    <span class="hljs-keyword">this</span>.heft = <span class="hljs-number">0</span>
    <span class="hljs-keyword">this</span>.holds = <span class="hljs-number">0</span>
}

Cartridge.prototype.adjustHeft = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">heft</span>) </span>{
    <span class="hljs-keyword">this</span>.heft += heft
    <span class="hljs-keyword">this</span>._magazine.heft += heft
    <span class="hljs-keyword">this</span>._magazine._cache.heft += heft
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>
}

Cartridge.prototype.release = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.holds) {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'attempt to release a cartridge not held'</span>)
    }
    <span class="hljs-keyword">if</span> (--<span class="hljs-keyword">this</span>.holds == <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">this</span>._magazine.holds--
        <span class="hljs-keyword">this</span>._magazine._cache.holds--
    }
}

Cartridge.prototype.remove = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.holds != <span class="hljs-number">1</span>) {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'attempt to remove cartridge held by others'</span>)
    }
    detach(<span class="hljs-keyword">this</span>)
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Purge</span> (<span class="hljs-params">object, next</span>) </span>{
    <span class="hljs-keyword">this</span>._object = object
    <span class="hljs-keyword">this</span>._next = next
    <span class="hljs-keyword">this</span>.cartridge = <span class="hljs-keyword">this</span>._object._head
    <span class="hljs-keyword">this</span>.next()
}

Purge.prototype.next = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">do</span> {
        <span class="hljs-keyword">this</span>.cartridge = <span class="hljs-keyword">this</span>.cartridge[<span class="hljs-keyword">this</span>._next] === <span class="hljs-keyword">this</span>._object._head
                       ? <span class="hljs-literal">null</span> : <span class="hljs-keyword">this</span>.cartridge[<span class="hljs-keyword">this</span>._next]
    } <span class="hljs-keyword">while</span> (<span class="hljs-keyword">this</span>.cartridge &amp;&amp; <span class="hljs-keyword">this</span>.cartridge.holds)
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.cartridge) {
        <span class="hljs-keyword">this</span>.cartridge.holds = <span class="hljs-number">1</span>
    }
}

Purge.prototype.release = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.cartridge) {
        <span class="hljs-keyword">this</span>.cartridge.release()
    }
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Iterator</span> (<span class="hljs-params">cartridge, direction</span>) </span>{
    <span class="hljs-keyword">this</span>.key = cartridge.key
    <span class="hljs-keyword">this</span>.when = cartridge.when
    <span class="hljs-keyword">this</span>.end = cartridge._terminal
    <span class="hljs-keyword">this</span>._cartridge = cartridge
    <span class="hljs-keyword">this</span>._direction = direction
}

Iterator.prototype.previous = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">do</span> {
        <span class="hljs-keyword">var</span> cartridge = <span class="hljs-keyword">this</span>._cartridge[<span class="hljs-keyword">this</span>._direction]
        <span class="hljs-keyword">var</span> detached = cartridge._detached
        <span class="hljs-keyword">this</span>.key = cartridge.key
        <span class="hljs-keyword">this</span>.when = cartridge.when
        <span class="hljs-keyword">this</span>.end = cartridge._terminal
        <span class="hljs-keyword">this</span>._cartridge = cartridge
    } <span class="hljs-keyword">while</span> (detached)

    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.end
}

Magazine.prototype.iterator = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Iterator(<span class="hljs-keyword">this</span>._head._magazinePrevious, <span class="hljs-string">'_magazinePrevious'</span>)
}

<span class="hljs-keyword">var</span> NULL = {}

Magazine.prototype.get = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">key, value</span>) </span>{
    <span class="hljs-keyword">var</span> cartridge, got
    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">arguments</span>.length == <span class="hljs-number">2</span>) {
        cartridge = <span class="hljs-keyword">this</span>.hold(key, value)
        got = cartridge.value
        cartridge.release()
    } <span class="hljs-keyword">else</span> {
        cartridge = <span class="hljs-keyword">this</span>.hold(key, NULL)
        <span class="hljs-keyword">if</span> (cartridge.value === NULL) {
            cartridge.remove()
        } <span class="hljs-keyword">else</span> {
            got = cartridge.value
            cartridge.release()
        }
    }
    <span class="hljs-keyword">return</span> got
}

Magazine.prototype.put = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">key, value</span>) </span>{
    <span class="hljs-keyword">var</span> cartridge = <span class="hljs-keyword">this</span>.hold(key, NULL), got
    <span class="hljs-keyword">if</span> (cartridge.value !== NULL) {
        got = cartridge.value
    }
    cartridge.value = value
    cartridge.release()
    <span class="hljs-keyword">return</span> got
}

Magazine.prototype.remove = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">key</span>) </span>{
    <span class="hljs-keyword">var</span> cartridge = <span class="hljs-keyword">this</span>.hold(key, NULL), got
    <span class="hljs-keyword">if</span> (cartridge.value !== NULL) {
        got = cartridge.value
    }
    cartridge.remove()
    <span class="hljs-keyword">return</span> got
}

<span class="hljs-built_in">module</span>.exports = Cache

</pre></div></div>

        </li>

    </ul>
  </div>
</body>
</html>
